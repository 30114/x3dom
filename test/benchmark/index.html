<!DOCTYPE html>
<html>
<head>
<title>Math Benchmark</title>

<script src="benchmark.js/benchmark.js"></script>
<script src="../../src/Internals.js"></script>
<script src="../../src/fields.js"></script>
<script src="../../src/math.js"></script>

<script>
  var global_id = 0;
  var global_current_test = 0;
  var global_tests = {};
  
  function formatNumber(number)
  {
    number = String(number).split('.');
    return number[0].replace(/(?=(?:\d{3})+$)(?!\b)/g, ',') + (number[1] ? '.' + number[1] : '');
  }
   
  create_test = function(suite, name, fields, math)
  {
    options = {};
    options.id = global_id++;
    
    suite.add("fields_" + options.id, fields, options);
    suite.add("math_"   + options.id, math,   options);
    
    var table = document.getElementById("results");
    var tr = document.createElement("tr");
    tr.style.backgroundColor = "#FFF"
    
    var td_name = document.createElement("td");
    var td_fields = document.createElement("td");
    var td_math = document.createElement("td");
    var td_delta = document.createElement("td");
    
    var button = document.createElement("input");
    button.type = "button";
    button.value = name;
    
    button.addEventListener("click", function()
    {
      suite.push("fields_" + options.id);
      suite.push("math_" + options.id);
      suite.run(true, true);
    });
    
    td_name.style.textAlign = "left";
    
    td_fields.style.textAlign = "right";
    td_fields.id = "fields_" + options.id;
    td_fields.innerHTML = "-";
    
    td_math.style.textAlign = "right";
    td_math.id = "math_" + options.id;
    td_math.innerHTML = "-";
    
    td_delta.id = "delta_" + options.id;
    td_delta.innerHTML = "-";
    
    td_name.appendChild(button);
    
    tr.appendChild(td_name);
    tr.appendChild(td_fields);
    tr.appendChild(td_math);
    tr.appendChild(td_delta);
    
    table.appendChild(tr);
  };
  
  cycle = function(event, bench)
  {
    var id = bench.id;
    
    if(!global_tests[id])
      global_tests[id] = {};
    global_tests[id][bench.name] = bench.hz;
    
    global_current_test++;
    
    if((global_current_test % 2) == 0)
    {
      var delta = document.getElementById("delta_" + id);
      
      var fields_frequency = global_tests[id]["fields_" + id];
      var math_frequency = global_tests[id]["math_" + id];
      
      var frequency_delta = ((100 / fields_frequency) * math_frequency).toFixed(2);
      
      if(frequency_delta < 100)
        delta.style.backgroundColor = "#C55";
      else
        delta.style.backgroundColor = "#5C5";
      
      delta.innerHTML = frequency_delta;
    }
      
    var result = document.getElementById(bench.name);
    console.log(String(bench));
    
    result.innerHTML  = formatNumber(bench.hz.toFixed()) + " ops/sec [ ";
    result.innerHTML += "&plusmn; " + bench.stats.rme.toFixed(2) + "% ";
    result.innerHTML += "@ " + bench.stats.size.toFixed() + " runs ]";
  };
  
  complete = function()
  {
    console.log(global_tests);
    console.log(this);
    console.log('Fastest is ' + this.filter('fastest').pluck('name'));
  };
  
  function init()
  {
    var applet = document.createElement("applet");
    applet.code = "nano";
    applet.archive = "benchmark.js/nano.jar";
    document.body.insertBefore(applet, document.body.firstChild);
    
    var temp = new math.mat4x4();
    var suite = new Benchmark.Suite;
    
    suite.on('cycle', cycle);
    suite.on('complete', complete);

    // TESTS

    create_test(suite, "mat4x4 (indentity)",
      function() { var temp = new x3dom.fields.SFMatrix4f(); },
      function() { var temp = new math.mat4x4(); }
    );
    
    create_test(suite, "mat4x4 (single values)",
      function() { var temp = new x3dom.fields.SFMatrix4f(1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1); },
      function() { var temp = new math.mat4x4(1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1); }
    );
    
    create_test(suite, "mat4x4 (array)",
      function() { var temp = new x3dom.fields.SFMatrix4f([1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1]); },
      function() { var temp = new math.mat4x4([1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1]); }
    );

    // TESTS
    
    // suite.run(true, true);
    
  };
</script>
</head>

<body onLoad="init();" style="background-color:#EEE">
  <article style="width:80em; margin:0 auto; background:#FFF; display:block; font-family:sans-serif">
    <article style="background:#FFF; padding:2em 2em;">
      <table border="0" cellpadding="1" callspacing="20" style="width:100%; text-align:center; background-color:#CCC">
        <thead>
          <tr style="background-color:#CCC; color:#FFF">
            <th >Test</th>
            <th width="400px">fields.js</th>
            <th width="400px">math.js</th>
            <th width="200px">Speedup %</th>
          </tr>
        </thead>
        <tbody id="results" style="color:#333">
        </tbody>
      </table>
    </article>
  </article>
</body>
</html>